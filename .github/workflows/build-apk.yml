name: æ„å»º Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'æ„å»ºç±»å‹'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

jobs:
  build:
    name: æ„å»ºå–æ°´æ‰“å¡ APK
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: â˜• è®¾ç½® Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸ”§ è®¾ç½® Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '8.7'

      - name: ğŸ“² å®‰è£… Android SDK ç»„ä»¶
        run: |
          echo "ğŸ“¥ å®‰è£… Android SDK Build Tools..."
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
            "build-tools;33.0.2" \
            "platforms;android-33" || true

      - name: ğŸ“¦ å®‰è£… Cordova CLI
        run: |
          npm install -g cordova@13.0.0
          echo "Cordova ç‰ˆæœ¬: $(cordova -v)"

      - name: ğŸ“± æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“± åº”ç”¨åç§°: $(grep -oP '(?<=<name>)[^<]+' config.xml | head -1)"
          echo "ğŸ“Œ åº”ç”¨ç‰ˆæœ¬: $(grep -oP '(?<=version=")[^"]+' config.xml | head -1)"
          echo "ğŸ†” åŒ…å: $(grep -oP '(?<=id=")[^"]+' config.xml | head -1)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ” æ£€æŸ¥ Android å¹³å°
        run: |
          if [ -d "platforms/android" ]; then
            echo "âœ… Android å¹³å°å·²å­˜åœ¨"
          else
            echo "â• æ·»åŠ  Android å¹³å°"
            cordova platform add android
          fi

      - name: ğŸ“‹ æ£€æŸ¥ç¯å¢ƒè¦æ±‚
        run: cordova requirements android || true

      - name: ğŸ—ï¸ æ„å»º APK (è°ƒè¯•ç‰ˆæœ¬)
        if: github.event.inputs.build_type != 'release'
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»ºè°ƒè¯•ç‰ˆæœ¬ APK..."
          cordova build android --debug --verbose
          echo "âœ… æ„å»ºå®Œæˆï¼"

      - name: ğŸ—ï¸ æ„å»º APK (å‘å¸ƒç‰ˆæœ¬)
        if: github.event.inputs.build_type == 'release'
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»ºå‘å¸ƒç‰ˆæœ¬ APK..."
          cordova build android --release --verbose
          echo "âœ… æ„å»ºå®Œæˆï¼"

      - name: ğŸ“Š APK ä¿¡æ¯
        run: |
          if [ "${{ github.event.inputs.build_type }}" == "release" ]; then
            APK_PATH="platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk"
          else
            APK_PATH="platforms/android/app/build/outputs/apk/debug/app-debug.apk"
          fi

          if [ -f "$APK_PATH" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… APK æ„å»ºæˆåŠŸï¼"
            echo "ğŸ“ ä½ç½®: $APK_PATH"
            echo "ğŸ“¦ å¤§å°: $(du -h "$APK_PATH" | cut -f1)"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            ls -lh "$APK_PATH"
          else
            echo "âŒ æœªæ‰¾åˆ° APK æ–‡ä»¶"
            exit 1
          fi

      - name: ğŸ“¤ ä¸Šä¼ è°ƒè¯•ç‰ˆ APK
        if: github.event.inputs.build_type != 'release'
        uses: actions/upload-artifact@v4
        with:
          name: å–æ°´æ‰“å¡-debug-${{ github.sha }}
          path: platforms/android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30

      - name: ğŸ“¤ ä¸Šä¼ å‘å¸ƒç‰ˆ APK
        if: github.event.inputs.build_type == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: å–æ°´æ‰“å¡-release-${{ github.sha }}
          path: platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk
          retention-days: 30

      - name: ğŸ‰ æ„å»ºå®Œæˆé€šçŸ¥
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ APK æ„å»ºæˆåŠŸï¼"
          echo "ğŸ“¥ è¯·åœ¨ Actions é¡µé¢çš„ Artifacts éƒ¨åˆ†ä¸‹è½½"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
