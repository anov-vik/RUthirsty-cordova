#!/bin/bash
# APK 构建助手 - 智能选择最佳构建方式
# 功能：自动检测环境并选择最优构建方案

set -e

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

clear

echo -e "${CYAN}╔═══════════════════════════════════════════════════════════╗${NC}"
echo -e "${CYAN}║${NC}  ${PURPLE}📱 Cordova APK 构建助手${NC}                              ${CYAN}║${NC}"
echo -e "${CYAN}║${NC}  ${BLUE}智能选择最佳构建方案${NC}                                ${CYAN}║${NC}"
echo -e "${CYAN}╚═══════════════════════════════════════════════════════════╝${NC}"
echo ""

# 检测当前环境
echo -e "${BLUE}🔍 正在检测构建环境...${NC}"
echo ""

# 检查是否是 Cordova 项目
if [ ! -f "config.xml" ]; then
    echo -e "${RED}❌ 错误: 当前目录不是 Cordova 项目${NC}"
    echo -e "${YELLOW}提示: 请在 Cordova 项目根目录运行此脚本${NC}"
    exit 1
fi

APP_NAME=$(grep -oP '(?<=<name>)[^<]+' config.xml | head -1)
APP_VERSION=$(grep -oP '(?<=version=")[^"]+' config.xml | head -1)
APP_ID=$(grep -oP '(?<=id=")[^"]+' config.xml | head -1)

echo -e "${GREEN}✓${NC} Cordova 项目检测成功"
echo -e "  ${CYAN}应用名称:${NC} $APP_NAME"
echo -e "  ${CYAN}版本号:${NC} $APP_VERSION"
echo -e "  ${CYAN}包名:${NC} $APP_ID"
echo ""

# 检查 Cordova CLI
if command -v cordova &> /dev/null; then
    CORDOVA_VERSION=$(cordova -v)
    echo -e "${GREEN}✓${NC} Cordova CLI: $CORDOVA_VERSION"
else
    echo -e "${YELLOW}⚠${NC} Cordova CLI 未安装"
fi

# 检查 Android SDK
if [ -n "$ANDROID_HOME" ] && [ -d "$ANDROID_HOME" ]; then
    echo -e "${GREEN}✓${NC} Android SDK 已配置"
    HAS_ANDROID_SDK=true
else
    echo -e "${YELLOW}⚠${NC} Android SDK 未配置"
    HAS_ANDROID_SDK=false
fi

# 检查 Git 仓库
if git remote -v &> /dev/null; then
    REPO_URL=$(git remote get-url origin 2>/dev/null || echo "未配置")
    echo -e "${GREEN}✓${NC} Git 仓库: $REPO_URL"
    HAS_GIT=true
else
    echo -e "${YELLOW}⚠${NC} 未配置 Git 仓库"
    HAS_GIT=false
fi

echo ""
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# 智能选择构建方案
if [ "$HAS_ANDROID_SDK" = true ]; then
    # 方案 1: 本地构建
    echo -e "${GREEN}🎯 推荐方案: 本地构建 (最快)${NC}"
    echo ""
    echo -e "检测到 Android SDK，可以直接构建 APK。"
    echo ""
    echo -e "${YELLOW}是否立即开始构建？${NC}"
    echo "  [1] 是，构建调试版本 (推荐)"
    echo "  [2] 是，构建发布版本"
    echo "  [3] 否，查看其他方案"
    echo "  [4] 退出"
    echo ""
    read -p "请选择 [1-4]: " choice

    case $choice in
        1)
            echo ""
            echo -e "${BLUE}🔨 开始构建调试版本...${NC}"
            ./cordova-build.sh debug
            ;;
        2)
            echo ""
            echo -e "${BLUE}🔨 开始构建发布版本...${NC}"
            ./cordova-build.sh release
            ;;
        3)
            # 继续显示其他方案
            ;;
        4)
            echo -e "${YELLOW}已取消${NC}"
            exit 0
            ;;
        *)
            echo -e "${RED}无效选择${NC}"
            exit 1
            ;;
    esac
fi

if [ "$HAS_GIT" = true ] && [ -f ".github/workflows/build-apk.yml" ]; then
    # 方案 2: GitHub Actions
    echo -e "${GREEN}🎯 推荐方案: GitHub Actions 云构建${NC}"
    echo ""
    echo -e "检测到 GitHub Actions 配置，可以使用云构建。"
    echo -e "${CYAN}优势:${NC} 无需本地 Android SDK，3-5 分钟获得 APK"
    echo ""

    if [ "$HAS_ANDROID_SDK" = false ]; then
        echo -e "${YELLOW}⚠ 本地未配置 Android SDK，推荐使用此方案${NC}"
        echo ""
    fi

    echo -e "${YELLOW}选择操作：${NC}"
    echo "  [1] 推送代码并自动触发构建"
    echo "  [2] 仅推送代码（稍后手动触发）"
    echo "  [3] 打开 GitHub Actions 页面"
    echo "  [4] 查看构建说明"
    echo "  [5] 退出"
    echo ""
    read -p "请选择 [1-5]: " choice

    case $choice in
        1)
            echo ""
            echo -e "${BLUE}📤 正在推送代码...${NC}"

            # 检查是否有未提交的更改
            if ! git diff-index --quiet HEAD --; then
                echo -e "${YELLOW}检测到未提交的更改，正在提交...${NC}"
                git add -A
                git commit -m "更新应用 - 触发自动构建"
            fi

            git push origin main || git push origin master

            echo ""
            echo -e "${GREEN}✓ 代码已推送！${NC}"
            echo ""
            echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
            echo -e "${GREEN}🎉 GitHub Actions 正在构建 APK！${NC}"
            echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
            echo ""
            echo -e "⏱️  ${YELLOW}预计时间:${NC} 3-5 分钟"
            echo ""
            echo -e "📥 ${YELLOW}查看构建进度:${NC}"

            # 提取仓库 URL
            if [ "$REPO_URL" != "未配置" ]; then
                ACTIONS_URL="${REPO_URL%.git}/actions"
                echo -e "   ${BLUE}$ACTIONS_URL${NC}"
                echo ""
                echo -e "💡 ${YELLOW}下载 APK:${NC}"
                echo "   1. 访问上面的链接"
                echo "   2. 点击最新的工作流"
                echo "   3. 等待完成（绿色 ✓）"
                echo "   4. 滚动到底部 Artifacts"
                echo "   5. 点击下载 ZIP"
                echo "   6. 解压得到 APK"
            fi
            ;;
        2)
            echo ""
            echo -e "${BLUE}📤 正在推送代码...${NC}"

            if ! git diff-index --quiet HEAD --; then
                git add -A
                git commit -m "更新应用代码"
            fi

            git push origin main || git push origin master
            echo -e "${GREEN}✓ 代码已推送${NC}"
            echo ""
            echo -e "${YELLOW}请手动访问 GitHub Actions 页面触发构建${NC}"
            ;;
        3)
            if [ "$REPO_URL" != "未配置" ]; then
                ACTIONS_URL="${REPO_URL%.git}/actions"
                echo ""
                echo -e "${BLUE}📱 GitHub Actions 页面:${NC}"
                echo "   $ACTIONS_URL"
                echo ""

                # 尝试在浏览器中打开
                if command -v xdg-open &> /dev/null; then
                    xdg-open "$ACTIONS_URL" 2>/dev/null || true
                elif command -v open &> /dev/null; then
                    open "$ACTIONS_URL" 2>/dev/null || true
                fi
            fi
            ;;
        4)
            echo ""
            cat << 'EOF'
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            GitHub Actions 构建说明
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📋 自动构建流程:
  1. 推送代码到 GitHub
  2. GitHub Actions 自动开始构建
  3. 3-5 分钟后完成
  4. 在 Actions 页面下载 APK

🔧 手动触发构建:
  1. 访问 Actions 页面
  2. 选择 "构建 Android APK"
  3. 点击 "Run workflow"
  4. 选择 branch 和构建类型
  5. 点击绿色按钮

📥 下载 APK:
  1. 打开完成的工作流
  2. 滚动到底部 "Artifacts"
  3. 点击下载（ZIP 格式）
  4. 解压得到 app-debug.apk

📖 详细文档:
  - GITHUB_ACTIONS_GUIDE.md

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
EOF
            ;;
        5)
            echo -e "${YELLOW}已取消${NC}"
            exit 0
            ;;
        *)
            echo -e "${RED}无效选择${NC}"
            exit 1
            ;;
    esac
else
    # 方案 3: 环境配置指导
    echo -e "${YELLOW}⚠ 未检测到可用的构建环境${NC}"
    echo ""
    echo -e "${BLUE}可用方案:${NC}"
    echo ""
    echo -e "${GREEN}方案 1: 配置本地环境${NC}"
    echo "  - 安装 Android Studio"
    echo "  - 配置 ANDROID_HOME"
    echo "  - 运行 ./cordova-build.sh"
    echo "  📖 详见: ANDROID_BUILD_GUIDE.md"
    echo ""
    echo -e "${GREEN}方案 2: 使用 GitHub Actions${NC}"
    echo "  - 设置 GitHub Actions 工作流"
    echo "  - 推送代码自动构建"
    echo "  - 在线下载 APK"
    echo "  📖 详见: GITHUB_ACTIONS_GUIDE.md"
    echo ""
    echo -e "${GREEN}方案 3: 下载项目到本地${NC}"
    echo "  - 在有 Android SDK 的机器上构建"
    echo "  - 使用自动化脚本"
    echo "  📖 详见: HOW_TO_BUILD_APK.md"
    echo ""

    echo -e "${YELLOW}选择操作：${NC}"
    echo "  [1] 查看本地环境配置指南"
    echo "  [2] 查看 GitHub Actions 配置"
    echo "  [3] 查看所有构建方案"
    echo "  [4] 退出"
    echo ""
    read -p "请选择 [1-4]: " choice

    case $choice in
        1)
            if [ -f "ANDROID_BUILD_GUIDE.md" ]; then
                less ANDROID_BUILD_GUIDE.md || cat ANDROID_BUILD_GUIDE.md
            else
                echo -e "${YELLOW}文档文件不存在${NC}"
            fi
            ;;
        2)
            if [ -f "GITHUB_ACTIONS_GUIDE.md" ]; then
                less GITHUB_ACTIONS_GUIDE.md || cat GITHUB_ACTIONS_GUIDE.md
            else
                echo -e "${YELLOW}文档文件不存在${NC}"
            fi
            ;;
        3)
            if [ -f "HOW_TO_BUILD_APK.md" ]; then
                less HOW_TO_BUILD_APK.md || cat HOW_TO_BUILD_APK.md
            else
                echo -e "${YELLOW}文档文件不存在${NC}"
            fi
            ;;
        4)
            echo -e "${YELLOW}已退出${NC}"
            exit 0
            ;;
        *)
            echo -e "${RED}无效选择${NC}"
            exit 1
            ;;
    esac
fi

echo ""
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${GREEN}✨ 操作完成！${NC}"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
